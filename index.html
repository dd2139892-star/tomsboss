<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>麥當勞單點專用v1（Web）</title>
<style>
  :root {
    --bg:#0b0f14; --card:#111827; --muted:#6b7280; --text:#e5e7eb; --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --border:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Arial}
  .container{max-width:1100px;margin:32px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
  .toolbar .btn{background:#1f2937;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  .toolbar .btn:hover{border-color:#334155}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .sound{display:flex;align-items:center;gap:8px;color:var(--muted)}
  select,input[type="text"],input[type="number"]{background:#0b1220;border:1px solid #22324a;color:var(--text);padding:8px;border-radius:10px}
  input[type="number"]{width:80px;text-align:center}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:center}
  th{color:#cbd5e1;font-weight:600}
  .timeSoon{color:var(--warn)}
  .timeDue{color:var(--bad);font-weight:700}
  .pill{display:inline-block;padding:4px 8px;border:1px solid #2a3a56;border-radius:999px;color:#93c5fd;background:#0b1220}
  .muted{color:var(--muted)}
  .footer{margin-top:8px;font-size:12px;color:#94a3b8}
  .hidden{display:none!important}
  /* 密碼遮罩 */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal{width:320px;background:#121826;border:1px solid #1f2a44;border-radius:14px;padding:18px}
  .modal h3{margin:0 0 10px;font-size:18px}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .modal button{background:#1f2937;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  .modal button.primary{background:#2563eb;border-color:#2563eb}
  .grid{display:grid;grid-template-columns:repeat(5, minmax(0,1fr));gap:10px}
  @media (max-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .copy-toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #334155;padding:8px 12px;border-radius:10px;color:#cbd5e1;opacity:0;transition:opacity .25s}
  .copy-toast.show{opacity:1}
  .btn.small{padding:2px 6px;font-size:12px}
</style>
</head>
<body>
<div id="pwOverlay" class="overlay">
  <div class="modal">
    <h3>密碼驗證</h3>
    <p class="muted" style="margin:6px 0 10px">請輸入本週密碼才能進入。</p>
    <input id="pwInput" type="password" placeholder="本週密碼" style="width:100%">
    <div class="actions">
      <button id="pwCancel">離開</button>
      <button id="pwOk" class="primary">確定</button>
    </div>
    <div id="pwMsg" class="muted" style="margin-top:8px;font-size:12px"></div>
  </div>
</div>

<div class="container">
  <h1>麥當勞單點專用v1（Web）</h1>

  <!-- 新增區 -->
  <div class="card">
    <div class="grid">
      <div>
        <div class="muted" style="margin-bottom:6px">章節 (EP)</div>
        <select id="ep"></select>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">地圖名稱</div>
        <select id="map"></select>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">等級</div>
        <input id="level" type="text" readonly>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">分流</div>
        <select id="channel"></select>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">倒數時間</div>
        <div class="row" style="align-items:center;gap:6px;flex-wrap:nowrap">
          <div>
            <button class="btn small" data-target="hh" data-delta="1">+1</button>
            <button class="btn small" data-target="hh" data-delta="5">+5</button>
            <input id="hh" type="number" value="0" min="0" max="99" />
            <button class="btn small" data-target="hh" data-delta="-1">-1</button>
            <button class="btn small" data-target="hh" data-delta="-5">-5</button>
            <span class="muted">時</span>
          </div>
          <div>
            <button class="btn small" data-target="mm" data-delta="1">+1</button>
            <button class="btn small" data-target="mm" data-delta="5">+5</button>
            <input id="mm" type="number" value="0" min="0" max="59" />
            <button class="btn small" data-target="mm" data-delta="-1">-1</button>
            <button class="btn small" data-target="mm" data-delta="-5">-5</button>
            <span class="muted">分</span>
          </div>
          <div>
            <button class="btn small" data-target="ss" data-delta="1">+1</button>
            <button class="btn small" data-target="ss" data-delta="5">+5</button>
            <input id="ss" type="number" value="0" min="0" max="59" />
            <button class="btn small" data-target="ss" data-delta="-1">-1</button>
            <button class="btn small" data-target="ss" data-delta="-5">-5</button>
            <span class="muted">秒</span>
          </div>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:12px;justify-content:space-between">
      <div class="toolbar">
        <button class="btn" id="addBtn">新增 BOSS</button>
        <button class="btn" id="copyCheckedBtn">複製勾選</button>
        <button class="btn" id="copyAllBtn">複製全部</button>
        <button class="btn" id="delCheckedBtn">清除勾選</button>
        <button class="btn" id="delAllBtn">清除全部</button>
      </div>
      <div class="sound">
        <label><input type="checkbox" id="soundToggle" checked> 啟用提示鈴聲</label>
        <span>提前提示</span>
        <select id="alertBefore">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="3">3</option>
          <option value="5">5</option>
          <option value="10">10</option>
        </select>
        <span>分鐘</span>
      </div>
    </div>
  </div>

  <!-- 清單 -->
  <div class="card" style="margin-top:12px">
    <table id="list">
      <thead>
        <tr>
          <th>✔</th>
          <th>章節</th>
          <th>地圖名稱</th>
          <th>等級</th>
          <th>分流</th>
          <th>時間</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="footer">依時間（實際到點）排序；相同「章節+地圖+分流」新增第二次會覆蓋第一次；資料儲存在瀏覽器的 localStorage。</div>
  </div>
</div>

<div id="toast" class="copy-toast">已複製到剪貼簿！</div>

<script>
const PASSWORD_URL = "https://script.google.com/macros/s/AKfycbyQB0VxmIukBcZRzFmRm4_xirXZIfMxNkY_h4LwAO4iiaUx3yw1JGjBZx0BO9mRvVb5/exec";

/* 時分秒加減控制 */
document.addEventListener('click', e=>{
  if (!e.target.matches('button[data-target]')) return;
  const id = e.target.getAttribute('data-target');
  const delta = parseInt(e.target.getAttribute('data-delta'),10) || 0;
  const input = document.getElementById(id);
  if (!input) return;

  let v = parseInt(input.value,10) || 0;
  v += delta;
  if (id === 'hh') v = Math.max(0, Math.min(99, v));
  if (id === 'mm' || id === 'ss') v = Math.max(0, Math.min(59, v));
  input.value = v;
});

/* 改良版密碼驗證 */
async function fetchPassword(timeoutMs = 8000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const r = await fetch(PASSWORD_URL, { cache:'no-cache', signal: ctrl.signal });
    if (!r.ok) throw new Error(`密碼 API 回應碼 ${r.status}`);
    const txt = (await r.text() || "").trim();
    if (!txt) throw new Error("密碼內容為空");
    return txt;
  } finally {
    clearTimeout(t);
  }
}
async function gate(){
  const overlay  = document.getElementById('pwOverlay');
  const msg      = document.getElementById('pwMsg');
  const input    = document.getElementById('pwInput');
  const okBtn    = document.getElementById('pwOk');
  const cancelBtn= document.getElementById('pwCancel');

  msg.textContent = "正在取得密碼…";
  input.value = "";
  okBtn.disabled = true;

  let correct = null;
  try{
    correct = await fetchPassword();
    msg.textContent = "";
    okBtn.disabled = false;
    input.focus();
  }catch(e){
    console.error("[gate] 密碼取得失敗：", e);
    msg.textContent = "無法取得密碼，請確認網路或稍後重整。";
    okBtn.disabled = false;
  }

  input.onkeypress = (e)=>{ if(e.key === 'Enter') tryCheck(); };
  okBtn.onclick = tryCheck;
  cancelBtn.onclick = ()=>overlay.classList.add('hidden');

  function tryCheck(){
    if (!correct){
      msg.textContent = "尚未取得密碼，請重整頁面或稍後再試。";
      return;
    }
    if ((input.value||"").trim() === correct){
      overlay.classList.add('hidden');
      msg.textContent = "";
    }else{
      msg.textContent = "密碼錯誤！";
      input.select();
    }
  }
}

/* 啟動 */
(async function init(){
  await gate();
})();
</script>
</body>
</html>
